// Start the book library
$(function onLoaded() {

    $("#flipbook").turn({
        width: 800,
        height: 600,
        autoCenter: true
    });

    // Websocket
    socketURL = "http://localhost:5000"

    // Create the socket (globally, for others to use)
    socket = io.connect(socketURL)
    socket.on("connect", function() {
        console.log("Connecte!");
        socket.emit("message");

    })
    socket.on("refresh", function() {
        console.log("refresh");
        $("#flipbook").turn("page", 1)
    })
    socket.on("left", function() {
        console.log("left");
        $("#flipbook").turn("previous")
    })
    socket.on("right", function() {
        console.log("right");
        $("#flipbook").turn("next")
    })

    var alignment = null;
    $('.guide').hide();

    // Add the alignment button
    $('#align-button').on('click', alignAll);
});


function alignAll() {
    if (alignment !== null) {
        clearTimeout(alignment);
    }

    alignment = setTimeout(alignChain, 0);
}

function alignChain(callback) {
    alignCenter(function() {
        alignLeft(function() {
            alignRight(callback);
        });
    });
}

function _align(guideClass, event, callback) {
    $('.guide').hide();
    $(guideClass).show();

    alignment = setTimeout(function() {
        console.log('Align Request')
        socket.emit(event);
        setTimeout(function() {
            console.log('Align Done')
            $('.guide').hide();
            return callback ? callback() : null;
        }, 200);
    }, 1200);
}

function alignLeft(callback) {
    return _align('.guide.left-border', 'align_left', callback);
}

function alignRight(callback) {
    return _align('.guide.right-border', 'align_right', callback);
}

function alignCenter(callback) {
    return _align('.guide.center-dot', 'recenter', callback);
}
